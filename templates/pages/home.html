{% extends '_base.html' %}
{% load static %}
{% load leaflet_tags %}
{% load static crispy_forms_tags %}

{% block title %}Pothole Monitor{% endblock title %}

{% block content %}
    <h1>Potholes in Purworejo, Central Java</h1>

    <div class="row">
        <div class="col-lg-9 col-md-9 col-xs-12">
            {% leaflet_map "main" callback="main_map_init" %}
        </div>
        <div id="div-leaflet-control" class="col-lg-3 col-md-3 col-xs-12">
            <form id='pothole-search-form' method="get">
                <div id="div_id_lebar" class="form-group">
                    <label for="id_lebar" class=" requiredField">Width<span class="asteriskField">*</span> </label>
                    <div class="">
                        <select name="width" class="select form-control" required="" id="id_lebar">
                            <option value="all" selected="">All</option>
                            {% for WIDTH in POTHOLE_WIDTH %}
                                <option value="{{ WIDTH.0 }}">{{ WIDTH.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div id="div_id_kedalaman" class="form-group">
                    <label for="id_kedalaman" class=" requiredField">Depth<span class="asteriskField">*</span> </label>
                    <div class="">
                        <select name="depth" class="select form-control" required="" id="id_kedalaman">
                            <option value="all" selected="">All</option>
                            {% for DEPTH in POTHOLE_DEPTH %}
                                <option value="{{ DEPTH.0 }}">{{ DEPTH.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div id="div_id_response" class="form-group">
                    <label for="id_response" class=" requiredField">Response Time Needed<span class="asteriskField">*</span> </label>
                    <div class="">
                        <select name="response_time_needed" class="select form-control" required="" id="id_response">
                            <option value="all" selected="">All</option>
                            {% for RESPONSE in POTHOLE_RESPONSE %}
                                <option value="{{ RESPONSE.0 }}">{{ RESPONSE.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <input type="submit" name="submit" value="Show" class="btn btn-primary" id="submit-id-search">
            </form>
        </div>
    </div>


    <!-- Modal -->
    <div class="modal fade bd-example-modal-lg" id="pothole-modal" role="dialog" aria-labelledby="pothole-modal-Label" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <div class="card">
                <div class="card-body">
                    <form id='pothole-form' method="post" enctype="multipart/form-data">
                        {% if form.non_field_errors %}
                            <ul>
                              {% for error in form.non_field_errors %}
                                <li>{{ error }}</li>
                              {% endfor %}
                            </ul>
                        {% endif %}
                        {{ form.media }}
                        {% crispy form %}
                    </form>
                </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade bd-example-modal-lg" id="pothole-detail-modal" role="dialog" aria-labelledby="pothole-detail-modal-Label" aria-hidden="true">
      <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
              <table class="table table-striped table-sm">
                    <tr>
                        <th>Photo</th>
                        <th style="width: 11vw">Width</th>
                    </tr>
                    <tr>
                        <td rowspan="5" id="pothole-detail-photo" style="width: 40vw;"></td>
                        <td id="pothole-detail-width"></td>
                    </tr>
                    <tr>
                        <th style="width: 11vw">Depth</th>
                    </tr>
                    <tr>
                        <td id="pothole-detail-depth"></td>
                    </tr>
                    <tr>
                        <th style="width: 16vw">Response Time Needed</th>
                    </tr>
                    <tr>
                        <td id="pothole-detail-response"></td>
                    </tr>
              </table>
          </div>
        </div>
      </div>
    </div>

{% endblock content %}


{% block css %}
    <style></style>

    {% leaflet_css %}
    <style>

        .leaflet-container {  /* all maps */
            width:  60vw;
            height: 75vh;
        }

        #specialbigmap {
            height: 800px;
        }

    </style>
{% endblock css %}

{% block javascript %}
    {% leaflet_js %}
    <script src="{% static 'js/Leaflet.SvgShapeMarkers-gh-pages/dist/leaflet-svg-shape-markers.js' %}"></script>
    <script type="text/javascript">
            let POTHOLEPROP = {};

            let shape;
            let opacity;
            let color;
            {% for WIDTH in POTHOLE_WIDTH %}
                switch ('{{ WIDTH.0 }}') {
                    case '1':
                        shape = 'triangle-down';
                        break;
                    case '2':
                        shape = 'square';
                        break;
                    case '3':
                        shape = 'circle';
                        break;
                }

                POTHOLEPROP['{{ WIDTH.0 }}'] = {'value': shape};

                {% for DEPTH in POTHOLE_DEPTH %}
                    switch ('{{ DEPTH.0 }}') {
                        case '1':
                            opacity = 0.4;
                            break;
                        case '2':
                            opacity = 0.7;
                            break;
                        case '3':
                            opacity = 1;
                            break;
                    }

                    POTHOLEPROP['{{ WIDTH.0 }}']['{{ DEPTH.0 }}'] = {'value': opacity};

                    {% for RESPONSE in POTHOLE_RESPONSE %}
                        switch ('{{ RESPONSE.0 }}') {
                            case '1':
                                color = 'black';
                                break;
                            case '2':
                                color = 'red';
                                break;
                            case '3':
                                color = 'blue';
                                break;
                            case '4':
                                color = 'purple';
                                break
                        }

                        POTHOLEPROP['{{ WIDTH.0 }}']['{{ DEPTH.0 }}']['{{ RESPONSE.0 }}'] = {'value': color};
                    {% endfor %}
                {% endfor %}
            {% endfor %}

            let holes = [];
            function main_map_init(map, options) {
                let geom = [0, 0];
                let circle;
                {% for pothole in pothole_list %}

                    geom[0] = {{ pothole.geometry.1 }};
                    geom[1] = {{ pothole.geometry.0 }};

                    circle = {
                        radius: 9,
                        shape: POTHOLEPROP['{{ pothole.width }}']['value'],
                        fillOpacity: POTHOLEPROP['{{ pothole.width }}']['{{ pothole.depth }}']['value'],
                        opacity: POTHOLEPROP['{{ pothole.width }}']['{{ pothole.depth }}']['value'],
                        color: POTHOLEPROP['{{ pothole.width }}']['{{ pothole.depth }}']['{{ pothole.response_time_needed }}']['value'],
                        weight: 0,
                        potholeId: {{ pothole.id }},
                        width: '{{ pothole.get_width_display }}',
                        depth: '{{ pothole.get_depth_display }}',
                        responseNeeded: '{{ pothole.get_response_time_needed_display }}',
                        photo: '{{ pothole.photo.url }}',
                        clickable: true,
                    };

                    var marker = L.shapeMarker(geom, circle).on('click', function(e) {
                        $('#pothole-detail-width').html(this.options.width);
                        $('#pothole-detail-depth').html(this.options.depth);
                        $('#pothole-detail-response').html(this.options.responseNeeded);
                        $('#pothole-detail-photo').html('<img class="center" src="'+ this.options.photo +'" alt="pothole-image"></img>');
                        $('#pothole-detail-modal').modal('show');

                        e.preventDefault();
                    });
                    holes.push(marker);
                {% endfor %}

                var markers = L.layerGroup(holes);
                map.addLayer(markers);

                {% if request.user.is_authenticated %}
                    map.on('click', function addMarker(e) {
                        // Add marker to map at click location; add popup window
                        $('#pothole-modal').modal('show');

                        $('#pothole-form').unbind('submit').bind('submit',function(eventSubmit) {
                            eventSubmit.preventDefault();

                            var formData = new FormData(this);
                            formData.append("geometry",
                                "{\"type\":\"Point\",\"coordinates\":["+e.latlng.lat+","+e.latlng.lng+"]}"
                            );

                            $.ajax({
                              type: "POST",
                              async: true,
                              url: "{% url 'pothole:pothole_create' %}",
                              processData: false,
                              contentType: false,
                              data: formData,
                              success: function (data) {
                                  var mark = data.success;
                                  var width = mark.features[0].properties.width;
                                  var depth = mark.features[0].properties.depth;
                                  var responseTimeNeeded = mark.features[0].properties.response_time_needed;
                                  var widthDisplay = mark.features[0].properties.get_width_display;
                                  var depthDisplay = mark.features[0].properties.get_depth_display;
                                  var responseTimeNeededDisplay = mark.features[0].properties.get_response_time_needed_display;
                                  var potholeId = mark.features[0].properties.id;
                                  var photo = mark.features[0].properties.photo;

                                  circle = {
                                        radius: 9,
                                        shape: POTHOLEPROP[width]['value'],
                                        fillOpacity: POTHOLEPROP[width][depth]['value'],
                                        opacity: POTHOLEPROP[width][depth]['value'],
                                        color: POTHOLEPROP[width][depth][responseTimeNeeded]['value'],
                                        weight: 0,
                                        potholeId: potholeId,
                                        width: widthDisplay,
                                        depth: depthDisplay,
                                        responseNeeded: responseTimeNeededDisplay,
                                        photo: photo,
                                        clickable: true,
                                    };

                                  var marker = L.shapeMarker(e.latlng, circle).on('click', function(eventClick) {
                                        $('#pothole-detail-width').html(this.options.width);
                                        $('#pothole-detail-depth').html(this.options.depth);
                                        $('#pothole-detail-response').html(this.options.responseNeeded);
                                        $('#pothole-detail-photo').html('<img class="center" src="'+ this.options.photo +'" alt="pothole-image" style="height:40vh;"></img>');
                                        $('#pothole-detail-modal').modal('show');
                                        eventClick.preventDefault();
                                    });

                                  marker.addTo(markers);

                                  $('#pothole-modal').modal('hide');
                              },
                              error: function (data) {
                                  alert('Failed saving Pothole!')
                              }
                            });
                        });
                    });
                {% endif %}

                var legend = L.control({position: 'bottomleft'});
                legend.onAdd = function (map) {
                    var div = L.DomUtil.create('div', 'info-legend');
                    var labels = ['<strong>Width (Shape)</strong>'];

                    {% for WIDTH in POTHOLE_WIDTH %}
                        var shape = POTHOLEPROP['{{ WIDTH.0 }}']['value'];
                        var item = '';
                        if(shape==='triangle-down'){
                            item = '<i class="fa fa-caret-down fa-2x" style="color:' + shape + '"></i> ' + ('{{ WIDTH.1 }}');
                        }
                        else{
                            item = '<i class="fa fa-'+ shape +'" style="color:' + shape + '"></i> ' + ('{{ WIDTH.1 }}');
                        }
                        div.innerHTML += labels.push(item);
                    {% endfor %}

                    div.innerHTML = labels.join('<br>');
                    return div;
                };
                legend.addTo(map);

                legend = L.control({position: 'bottomleft'});
                legend.onAdd = function (map) {
                    var div = L.DomUtil.create('div', 'info-legend');
                    var labels = ['<strong>Depth (Opacity)</strong>'];

                    {% for DEPTH in POTHOLE_DEPTH %}
                        var opacity = POTHOLEPROP['1']['{{ DEPTH.0 }}']['value']*100;
                        div.innerHTML +=
                        labels.push('<i class="fa fa-circle" style="opacity:' + opacity + '%"></i> ' + ('{{ DEPTH.1 }}'));
                    {% endfor %}

                    div.innerHTML = labels.join('<br>');
                    return div;
                };
                legend.addTo(map);

                legend = L.control({position: 'bottomleft'});
                legend.onAdd = function (map) {
                    var div = L.DomUtil.create('div', 'info-legend');
                    var labels = ['<strong>Response Time Needed (Color)</strong>'];

                    {% for RESPONSE in POTHOLE_RESPONSE %}
                        var color = POTHOLEPROP['1']['1']['{{ RESPONSE.0 }}']['value'];
                        div.innerHTML +=
                        labels.push('<i class="fa fa-circle" style="color:' + color + '"></i> ' + ('{{ RESPONSE.1 }}'));
                    {% endfor %}

                    div.innerHTML = labels.join('<br>');
                    return div;
                };
                legend.addTo(map);

                $('.info-legend').css( {'background':'white'});

                $('#pothole-search-form').unbind('submit').bind('submit',function(eventSubmit) {
                        eventSubmit.preventDefault();

                        var width = $('#id_lebar').val();
                        var depth = $('#id_kedalaman').val();
                        var response = $('#id_response').val();

                        $.ajax({
                          type: "GET",
                          async: true,
                          url: "{% url 'pothole:pothole_list' %}?width="+width+'&depth='+depth+'&response='+response,
                          success: function (data) {
                              markers.clearLayers();
                              var mark = data.success;
                              $.each(mark.features, function (idx,val) {
                                  var width = val.properties.width;
                                  var depth = val.properties.depth;
                                  var responseTimeNeeded = val.properties.response_time_needed;
                                  var widthDisplay = val.properties.get_width_display;
                                  var depthDisplay = val.properties.get_depth_display;
                                  var responseTimeNeededDisplay = val.properties.get_response_time_needed_display;
                                  var potholeId = val.properties.id;
                                  var photo = val.properties.photo;
                                  var geometry = val.geometry.coordinates;

                                  circle = {
                                      radius: 9,
                                      shape: POTHOLEPROP[width]['value'],
                                      fillOpacity: POTHOLEPROP[width][depth]['value'],
                                      opacity: POTHOLEPROP[width][depth]['value'],
                                      color: POTHOLEPROP[width][depth][responseTimeNeeded]['value'],
                                      weight: 0,
                                      potholeId: potholeId,
                                      width: widthDisplay,
                                      depth: depthDisplay,
                                      responseNeeded: responseTimeNeededDisplay,
                                      photo: photo,
                                      clickable: true,
                                  };

                                  var marker = L.shapeMarker([geometry[1], geometry[0]], circle).on('click', function (eventClick) {
                                      $('#pothole-detail-width').html(this.options.width);
                                      $('#pothole-detail-depth').html(this.options.depth);
                                      $('#pothole-detail-response').html(this.options.responseNeeded);
                                      $('#pothole-detail-photo').html('<img class="center" src="' + this.options.photo + '" alt="pothole-image" style="height:40vh;"></img>');
                                      $('#pothole-detail-modal').modal('show');
                                      eventClick.preventDefault();
                                  });

                                  marker.addTo(markers);
                              });

                          },
                          error: function (data) {
                              alert('Error loading Pothole!');
                          }
                        });
                });
            }
    </script>
{% endblock javascript %}
